{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">{{ titulo }}</h1>

<form method="POST">
    {{ form.hidden_tag() }}

    <div class="row">
        <div class="col-md-6 mb-3">
            {{ form.doctor.label(class="form-label") }}
            <select name="doctor" class="form-select" required>
                <option value="">-- Seleccionar Doctor --</option>
                {% for d in doctores %}
                <option value="{{ d.id }}" {% if form.doctor.data == d.id %}selected{% endif %}>
                    {{ d.nombre_completo() }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 mb-3">
            {{ form.paciente.label(class="form-label") }}
            {{ form.paciente(class="form-control") }}
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            {{ form.tipo_trabajo.label(class="form-label") }}
            <select name="tipo_trabajo" class="form-select" required>
                <option value="">-- Seleccionar Tipo Trabajo --</option>
                {% for t in tipos_trabajo %}
                <option value="{{ t.id }}" {% if form.tipo_trabajo.data == t.id %}selected{% endif %}>
                    {{ t.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 mb-3">
            {{ form.trabajo.label(class="form-label") }}
            <select name="trabajo" id="trabajo" class="form-select" required>
                <option value="">-- Seleccionar Trabajo --</option>
                {% for t in trabajos %}
                <option value="{{ t.id }}" data-precio="{{ t.valor_arancel }}" {% if form.trabajo.data == t.id %}selected{% endif %}>
                    {{ t.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4 mb-3">
            {{ form.maxilar.label(class="form-label") }}
            <select name="maxilar" class="form-select" required>
                <option value="Superior">Superior</option>
                <option value="Inferior">Inferior</option>
                <option value="Ambos">Ambos</option>
            </select>
        </div>
        <div class="col-md-4 mb-3">
            {{ form.cant_piezas.label(class="form-label") }}
            {{ form.cant_piezas(class="form-control form-control-sm", readonly=True, id="cant_piezas") }}
        </div>
        <div class="col-md-4 mb-3">
            {{ form.arancel.label(class="form-label") }}
            <div class="input-group input-group-sm">
                <span class="input-group-text">$</span>
                {{ form.arancel(class="form-control", readonly=True) }}
            </div>
        </div>
    </div>

    <!-- Detalle Piezas -->
    <div class="mb-3">
        <label class="form-label">Detalle Piezas</label>
        <div class="teeth-container p-3 border rounded bg-light">
            <div class="text-center mb-3 fw-bold">MAXILAR SUPERIOR DERECHA</div>
            <div class="d-flex justify-content-center gap-2 mb-4 flex-wrap">
                {% for num in ['18', '17', '16', '15', '14', '13', '12', '11'] %}
                <button type="button" class="btn btn-outline-primary btn-sm tooth" data-number="{{ num }}">{{ num }}</button>
                {% endfor %}
            </div>
            <div class="text-center mb-3 fw-bold">MAXILAR SUPERIOR IZQUIERDA</div>
            <div class="d-flex justify-content-center gap-2 mb-4 flex-wrap">
                {% for num in ['21', '22', '23', '24', '25', '26', '27', '28'] %}
                <button type="button" class="btn btn-outline-primary btn-sm tooth" data-number="{{ num }}">{{ num }}</button>
                {% endfor %}
            </div>
            <div class="text-center mb-3 fw-bold">MAXILAR INFERIOR DERECHA</div>
            <div class="d-flex justify-content-center gap-2 mb-4 flex-wrap">
                {% for num in ['48', '47', '46', '45', '44', '43', '42', '41'] %}
                <button type="button" class="btn btn-outline-primary btn-sm tooth" data-number="{{ num }}">{{ num }}</button>
                {% endfor %}
            </div>
            <div class="text-center mb-3 fw-bold">MAXILAR INFERIOR IZQUIERDA</div>
            <div class="d-flex justify-content-center gap-2 flex-wrap">
                {% for num in ['31', '32', '33', '34', '35', '36', '37', '38'] %}
                <button type="button" class="btn btn-outline-primary btn-sm tooth" data-number="{{ num }}">{{ num }}</button>
                {% endfor %}
            </div>
        </div>
        {{ form.detalle_piezas(id="detalle_piezas", class="form-control mt-2", readonly=True) }}
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            {{ form.fecha_inicio.label(class="form-label") }}
            {{ form.fecha_inicio(class="form-control", type="date") }}
        </div>
        <div class="col-md-6 mb-3">
            {{ form.fecha_entrega.label(class="form-label") }}
            {{ form.fecha_entrega(class="form-control", type="date") }}
        </div>
    </div>

    <div class="mb-3">
        {{ form.indicaciones.label(class="form-label") }}
        {{ form.indicaciones(class="form-control", rows=4) }}
    </div>

    <!-- Renglón achicado: Número Factura + Estado Orden -->
    <div class="row g-3">
        <div class="col-md-4">
            {{ form.numero_factura.label(class="form-label small") }}
            <select name="numero_factura" id="numero_factura" class="form-select form-select-sm">
                <option value="0">-- Sin factura --</option>
                {% for f in facturas %}
                <option value="{{ f.id }}" data-estado="{{ f.estado }}" data-importe="{{ f.importe }}" {% if form.numero_factura.data == f.id %}selected{% endif %}>
                    {{ f.numero_factura }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label small">Importe Factura</label>
            <div class="input-group input-group-sm">
                <span class="input-group-text">$</span>
                <input type="text" class="form-control" id="importe_factura" readonly value="0.00">
            </div>
        </div>
        <div class="col-md-4">
            <label class="form-label small">Estado Facturación</label>
            <input type="text" class="form-control form-control-sm" id="estado_facturacion" readonly>
        </div>
        <div class="col-md-4">
            {{ form.estado_orden.label(class="form-label small") }}
            {{ form.estado_orden(class="form-select form-select-sm") }}
        </div>
    </div>

    {{ form.submit(class="btn btn-success btn-lg mt-3") }}
    <a href="{{ url_for('ordenes_trabajo') }}" class="btn btn-secondary btn-lg ms-2 mt-3">Cancelar</a>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const detalleInput = document.getElementById('detalle_piezas');
    const cantInput = document.getElementById('cant_piezas');
    const trabajoSelect = document.getElementById('trabajo');
    const arancelInput = document.querySelector('input[name="arancel"]');
    const facturaSelect = document.getElementById('numero_factura');
    const estadoFacturacionInput = document.getElementById('estado_facturacion');
    const importeFacturaInput = document.getElementById('importe_factura');
    let selected = detalleInput.value ? detalleInput.value.split(', ').map(n => n.trim()) : [];

    // Restaurar selección inicial de piezas (edición)
    document.querySelectorAll('.tooth').forEach(btn => {
        const num = btn.getAttribute('data-number');
        if (selected.includes(num)) {
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-primary');
        }
    });

    // Toggle piezas (web + móvil)
    document.querySelectorAll('.tooth').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const num = this.getAttribute('data-number');

            if (selected.includes(num)) {
                selected = selected.filter(n => n !== num);
                this.classList.remove('btn-primary');
                this.classList.add('btn-outline-primary');
            } else {
                selected.push(num);
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-primary');
            }

            selected.sort((a, b) => Number(a) - Number(b));
            detalleInput.value = selected.join(', ');
            cantInput.value = selected.length || 0;
        });
    });

    // ARANCEL: solo se actualiza con el valor del TRABAJO (no de la factura)
    trabajoSelect.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        const precio = option.getAttribute('data-precio') || '0.00';
        arancelInput.value = parseFloat(precio).toFixed(2);
    });

    // Autocompletar solo Estado e Importe de la factura (sin tocar arancel)
    facturaSelect.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        const estado = option.getAttribute('data-estado') || '';
        const importe = option.getAttribute('data-importe') || '0.00';

        if (estadoFacturacionInput) estadoFacturacionInput.value = estado;
        if (importeFacturaInput) importeFacturaInput.value = parseFloat(importe).toFixed(2);
    });

    // Inicializar valores al cargar (edición)
    if (trabajoSelect.value) trabajoSelect.dispatchEvent(new Event('change'));
    if (facturaSelect.value) facturaSelect.dispatchEvent(new Event('change'));
});
</script>

{% endblock %}
