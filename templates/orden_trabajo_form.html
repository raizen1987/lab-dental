{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">{{ titulo }}</h1>

<form method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}

    <div class="row">
        <div class="col-md-6 mb-3">
            {{ form.doctor.label(class="form-label") }}
            <select name="doctor" class="form-select" required>
                <option value="">-- Seleccionar Doctor --</option>
                {% for d in doctores %}
                <option value="{{ d.id }}" {% if form.doctor.data == d.id %}selected{% endif %}>
                    {{ d.nombre_completo() }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 mb-3">
            {{ form.paciente.label(class="form-label") }}
            {{ form.paciente(class="form-control") }}
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            {{ form.tipo_trabajo.label(class="form-label") }}
            <select name="tipo_trabajo" class="form-select" required>
                <option value="">-- Seleccionar Tipo Trabajo --</option>
                {% for t in tipos_trabajo %}
                <option value="{{ t.id }}" {% if form.tipo_trabajo.data == t.id %}selected{% endif %}>
                    {{ t.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 mb-3">
            {{ form.trabajo.label(class="form-label") }}
            <select name="trabajo" id="trabajo" class="form-select" required>
                <option value="">-- Seleccionar Trabajo --</option>
                {% for t in trabajos %}
                <option value="{{ t.id }}" data-precio="{{ t.valor_arancel }}" {% if form.trabajo.data == t.id %}selected{% endif %}>
                    {{ t.nombre }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4 mb-3">
            {{ form.arancel.label(class="form-label") }}
            <div class="input-group input-group-sm">
                <span class="input-group-text">$</span>
                {{ form.arancel(class="form-control", readonly=true, id="arancel") }}
            </div>
        </div>
        <div class="col-md-4 mb-3">
            {{ form.porcentaje_bonificacion.label(class="form-label") }}
            {{ form.porcentaje_bonificacion(class="form-control", id="porcentaje_bonificacion", placeholder="Ej: 15.5", step="0.01", disabled=true) }}
        </div>
        <div class="col-md-4 mb-3">
            {{ form.importe_final.label(class="form-label") }}
            <div class="input-group input-group-sm">
                <span class="input-group-text">$</span>
                {{ form.importe_final(class="form-control", id="importe_final", readonly=true) }}
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="form-check">
                {{ form.bonificacion(class="form-check-input", id="bonificacion_check") }}
                {{ form.bonificacion.label(class="form-check-label", for="bonificacion_check") }}
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-4 mb-3">
            {{ form.maxilar.label(class="form-label") }}
            <select name="maxilar" class="form-select" required>
                <option value="Superior">Superior</option>
                <option value="Inferior">Inferior</option>
                <option value="Ambos">Ambos</option>
            </select>
        </div>
        <div class="col-md-4 mb-3">
            {{ form.cant_piezas.label(class="form-label") }}
            {{ form.cant_piezas(class="form-control form-control-sm", readonly=True, id="cant_piezas") }}
        </div>
    </div>

    <!-- Detalle Piezas -->
    <div class="mb-3">
        <label class="form-label">Detalle Piezas</label>
        <div class="teeth-container p-3 border rounded bg-light">
            <div class="text-center mb-3 fw-bold">MAXILAR SUPERIOR DERECHA</div>
            <div class="d-flex justify-content-center gap-2 mb-4 flex-wrap">
                {% for num in ['17', '16', '15', '14', '13', '12', '11'] %}
                <button type="button" class="btn btn-outline-primary btn-sm tooth" data-number="{{ num }}">{{ num }}</button>
                {% endfor %}
            </div>
            <div class="text-center mb-3 fw-bold">MAXILAR SUPERIOR IZQUIERDA</div>
            <div class="d-flex justify-content-center gap-2 mb-4 flex-wrap">
                {% for num in ['21', '22', '23', '24', '25', '26', '27'] %}
                <button type="button" class="btn btn-outline-primary btn-sm tooth" data-number="{{ num }}">{{ num }}</button>
                {% endfor %}
            </div>
            <div class="text-center mb-3 fw-bold">MAXILAR INFERIOR DERECHA</div>
            <div class="d-flex justify-content-center gap-2 mb-4 flex-wrap">
                {% for num in ['47', '46', '45', '44', '43', '42', '41'] %}
                <button type="button" class="btn btn-outline-primary btn-sm tooth" data-number="{{ num }}">{{ num }}</button>
                {% endfor %}
            </div>
            <div class="text-center mb-3 fw-bold">MAXILAR INFERIOR IZQUIERDA</div>
            <div class="d-flex justify-content-center gap-2 flex-wrap">
                {% for num in ['31', '32', '33', '34', '35', '36', '37'] %}
                <button type="button" class="btn btn-outline-primary btn-sm tooth" data-number="{{ num }}">{{ num }}</button>
                {% endfor %}
            </div>
        </div>
        {{ form.detalle_piezas(id="detalle_piezas", class="form-control mt-2", readonly=True) }}
    </div>

    <div class="row">
        <div class="col-md-6 mb-3">
            {{ form.fecha_inicio.label(class="form-label") }}
            {{ form.fecha_inicio(class="form-control", type="date") }}
        </div>
        <div class="col-md-6 mb-3">
            {{ form.fecha_entrega.label(class="form-label") }}
            {{ form.fecha_entrega(class="form-control", type="date") }}
        </div>
        <div class="col-md-6 mb-3">
            {{ form.fecha_turno_paciente.label(class="form-label") }}
            {{ form.fecha_turno_paciente(class="form-control", type="date") }}
        </div>
    </div>

    <div class="mb-3">
        {{ form.indicaciones.label(class="form-label") }}
        {{ form.indicaciones(class="form-control", rows=4) }}
    </div>
    <div class="col-md-4">
            {{ form.estado_orden.label(class="form-label small") }}
            {{ form.estado_orden(class="form-select form-select-sm") }}
    </div>

    {{ form.submit(class="btn btn-success btn-lg mt-3") }}
    <a href="{{ url_for('ordenes_trabajo') }}" class="btn btn-secondary btn-lg ms-2 mt-3">Cancelar</a>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const detalleInput = document.getElementById('detalle_piezas');
    const cantInput = document.getElementById('cant_piezas');
    let selected = detalleInput.value ? detalleInput.value.split(', ').map(n => n.trim()) : [];

    // Restaurar selección inicial de piezas (edición)
    document.querySelectorAll('.tooth').forEach(btn => {
        const num = btn.getAttribute('data-number');
        if (selected.includes(num)) {
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-primary');
        }
    });

    // Toggle piezas (web + móvil)
    document.querySelectorAll('.tooth').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const num = this.getAttribute('data-number');

            if (selected.includes(num)) {
                selected = selected.filter(n => n !== num);
                this.classList.remove('btn-primary');
                this.classList.add('btn-outline-primary');
            } else {
                selected.push(num);
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-primary');
            }

            selected.sort((a, b) => Number(a) - Number(b));
            detalleInput.value = selected.join(', ');
            cantInput.value = selected.length || 0;
        });
    });

});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const detalleInput = document.getElementById('detalle_piezas');
    const cantInput = document.getElementById('cant_piezas');
    const trabajoSelect = document.getElementById('trabajo');
    const arancelInput = document.getElementById('arancel');
    const porcentajeInput = document.getElementById('porcentaje_bonificacion');
    const importeFinalInput = document.getElementById('importe_final');
    const bonificacionCheck = document.getElementById('bonificacion_check');

    // Valor inicial del arancel fijo (viene del backend y NO lo tocamos nunca)
    const arancelFijoOriginal = parseFloat(arancelInput.value) || 0;
    let arancelFijoActual = arancelFijoOriginal;  // este sí se puede actualizar si cambia el trabajo

    // Toggle bonificación
    function togglePorcentaje() {
        if (bonificacionCheck.checked) {
            porcentajeInput.disabled = false;
            porcentajeInput.classList.remove('bg-light', 'text-muted');
            porcentajeInput.classList.add('bg-white');
        } else {
            porcentajeInput.disabled = true;
            porcentajeInput.classList.add('bg-light', 'text-muted');
            porcentajeInput.classList.remove('bg-white');
            porcentajeInput.value = '';
        }
        calcularImporteFinal();
    }

    // Calcular importe final en vivo
    function calcularImporteFinal() {
        let arancel = parseFloat(arancelInput.value) || 0;
        let porcentaje = parseFloat(porcentajeInput.value) || 0;

        if (bonificacionCheck.checked && porcentaje > 0) {
            let descuento = arancel * (porcentaje / 100);
            let final = arancel - descuento;
            importeFinalInput.value = final.toFixed(2);
        } else {
            importeFinalInput.value = arancel.toFixed(2);
        }
    }

    // Cuando cambia el trabajo → actualizamos el arancel solo si es un trabajo nuevo
    trabajoSelect.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        const precio = option.getAttribute('data-precio') || '0.00';
        const nuevoArancel = parseFloat(precio).toFixed(2);

        if (trabajoSelect.value === '{{ form.trabajo.data }}') {  // volviendo al original
            arancelInput.value = arancelFijoOriginal.toFixed(2);
            arancelFijoActual = arancelFijoOriginal;
        } else {
            arancelInput.value = nuevoArancel;
            arancelFijoActual = parseFloat(nuevoArancel);
        }

        calcularImporteFinal();
    });

    // Eventos bonificación y porcentaje
    bonificacionCheck.addEventListener('change', togglePorcentaje);
    porcentajeInput.addEventListener('input', calcularImporteFinal);

    // Inicializar al cargar: usamos el valor fijo original que viene del backend
    togglePorcentaje();
    calcularImporteFinal(); // calculamos con el valor fijo inicial
});
</script>

{% endblock %}
