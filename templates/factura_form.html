{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">{{ titulo }}</h1>

<form method="POST" id="facturaForm" enctype="multipart/form-data">
    {{ form.hidden_tag() }}

    <div class="row g-3">
        <div class="col-md-4">
            {{ form.numero_factura.label(class="form-label") }}
            {{ form.numero_factura(class="form-control", placeholder="Ej: 123456", pattern="[0-9]+", title="Solo números (sin letras ni símbolos)", required=True) }}
            <div class="invalid-feedback">
                Solo se permiten números (sin letras, espacios ni símbolos).
            </div>
        </div>
        <div class="col-md-4">
            {{ form.fecha.label(class="form-label") }}
            {{ form.fecha(class="form-control", type="date") }}
        </div>
        <div class="col-md-4">
            {{ form.estado.label(class="form-label") }}
            {{ form.estado(class="form-select") }}
        </div>
    </div>

    <div class="row g-3 mt-2">
        <div class="col-md-6">
            {{ form.destinatario.label(class="form-label") }}
            {{ form.destinatario(class="form-control") }}
        </div>
    </div>

    <!-- Botón que abre el modal -->
    <div class="mt-4 mb-3">
        <button type="button" class="btn btn-primary ms-auto" data-bs-toggle="modal" data-bs-target="#modalSeleccionOrdenes">
            Seleccionar Órdenes
        </button>
        <div class="mt-2">
            <strong>Órdenes seleccionadas: <span id="contadorOrdenes">0</span></strong>
        </div>
    </div>
<div class="mt-3">
    <div class="border rounded p-3 bg-light" style="min-height: 100px; max-height: 300px; overflow-y: auto;" id="listaOrdenesSeleccionadas">
        <!-- Las órdenes se agregan aquí con JS -->
        <p class="text-muted" id="noHayOrdenes">No hay órdenes seleccionadas todavía.</p>
    </div>
</div>
    <!-- Campo oculto para enviar las órdenes seleccionadas -->
    {{ form.ordenes(class="d-none") }}

    <!-- Campo de importe -->
    <div class="row g-3 mt-3">
        <div class="col-md-4">
            {{ form.importe.label(class="form-label") }}
            <div class="input-group">
                <span class="input-group-text">$</span>
                {{ form.importe(class="form-control", readonly=True, id="importe_total") }}
            </div>
        </div>
    </div>
    <div class="row g-3 mt-3">
        <div class="col-md-6">
            <label class="form-label fw-bold">Factura Digital (PDF)</label>
            <div class="input-group">
                <input type="file" name="archivo_pdf" class="form-control" accept=".pdf" />
            </div>
            <small class="text-muted">Solo archivos PDF (máx. 5MB)</small>
            {% if factura and factura.archivo_pdf %}
                <div class="mt-3">
                    <strong>Factura digital actual:</strong>
                    <a href="{{ url_for('static', filename=factura.archivo_pdf) }}" target="_blank" class="btn btn-sm btn-info ms-2">
                        <i class="bi bi-file-earmark-pdf-fill"></i> Ver/Descargar PDF actual
                    </a>
                    <small class="text-muted ms-2">(Si subís uno nuevo, reemplazará este)</small>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="mt-4 d-flex gap-2">
        {{ form.submit(class="btn btn-success btn-lg") }}
        <a href="{{ url_for('facturacion') }}" class="btn btn-secondary btn-lg">Cancelar</a>
    </div>
</form>

<!-- MODAL PARA SELECCIONAR ÓRDENES -->
<div class="modal fade" id="modalSeleccionOrdenes" tabindex="-1" aria-labelledby="modalOrdenesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalOrdenesLabel">Seleccionar Órdenes de Trabajo</h5>
            </div>
            <div class="modal-body">
                <!-- FILTROS dentro del modal -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <form id="filtroOrdenesModal" method="GET" class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label small">Fecha Desde</label>
                                <input type="date" name="fecha_desde" class="form-control" value="{{ request.args.get('fecha_desde') }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Fecha Hasta</label>
                                <input type="date" name="fecha_hasta" class="form-control" value="{{ request.args.get('fecha_hasta') }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Doctor</label>
                                <select name="doctor_id" class="form-select">
                                    <option value="">Todos</option>
                                    {% for d in doctores %}
                                    <option value="{{ d.id }}" {% if request.args.get('doctor_id') == d.id|string %}selected{% endif %}>
                                        {{ d.nombre_completo() }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Clínica del Doctor</label>
                                <input type="text" name="clinica" class="form-control" placeholder="Ej: Dental Total" value="{{ request.args.get('clinica') or '' }}">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Estado Orden</label>
                                <select name="estado_orden" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="Iniciado" {% if request.args.get('estado_orden') == 'Iniciado' %}selected{% endif %}>Iniciado</option>
                                    <option value="En Proceso" {% if request.args.get('estado_orden') == 'En Proceso' %}selected{% endif %}>En Proceso</option>
                                    <option value="Entregado" {% if request.args.get('estado_orden') == 'Entregado' %}selected{% endif %}>Entregado</option>
                                    <option value="Finalizado" {% if request.args.get('estado_orden') == 'Finalizado' %}selected{% endif %}>Finalizado</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Búsqueda rápida</label>
                                <input type="text" name="q" class="form-control" placeholder="Paciente / Detalle" value="{{ request.args.get('q') or '' }}">
                            </div>
                            <div class="col-12 d-flex gap-2 mt-3">
                                    <button type="button" class="btn btn-primary flex-grow-1" onclick="filtrarTabla()">Filtrar</button>
                                    <button type="button" class="btn btn-outline-secondary flex-grow-1" onclick="limpiarFiltros()">Limpiar Filtros</button>
                                </div>

                <!-- Tabla de órdenes dentro del modal -->
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-striped table-hover table-bordered" id="tablaOrdenesModal">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th><input type="checkbox" id="selectAllModal"></th>
                                <th>ID</th>
                                <th>Paciente</th>
                                <th>Doctor</th>
                                <th>Clínica</th>
                                <th>Trabajo</th>
                                <th>Arancel</th>
                                <th>Inicio</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for o in ordenes %}
                            <tr data-orden-id="{{ o.id }}" data-arancel="{{ o.arancel }}" data-doctor-id="{{ o.doctor_id or '' }}">
                                <td><input type="checkbox" class="orden-checkbox-modal"></td>
                                <td>{{ o.id }}</td>
                                <td>{{ o.paciente }}</td>
                                <td>{{ o.doctor.nombre_completo() if o.doctor else '-' }}</td>
                                <td>{{ o.doctor.clinica_particular or '-' }}</td>
                                <td>{{ o.trabajo.nombre if o.trabajo else '-' }}</td>
                                <td>${{ "%.2f"|format(o.arancel) }}</td>
                                <td>{{ o.fecha_inicio.strftime('%d/%m/%Y') if o.fecha_inicio else '-' }}</td>
                                <td>{{ o.estado_orden or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="if(confirm('¿Seguro que querés cancelar y quitar las órdenes seleccionadas?')) window.location.href = '{{ url_for(request.endpoint, **request.view_args) }}';">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmarSeleccionModal">Confirmar Selección</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const facturaForm = document.getElementById('facturaForm');
    const ordenesSelect = document.querySelector('select[name="ordenes"]');
    const importeInput = document.getElementById('importe_total');
    const modalElement = document.getElementById('modalSeleccionOrdenes');
    const modal = new bootstrap.Modal(modalElement);
    const selectAll = document.getElementById('selectAllModal');
    const checkboxes = document.querySelectorAll('.orden-checkbox-modal');
    const confirmarBtn = document.getElementById('confirmarSeleccionModal');
    const contador = document.getElementById('contadorOrdenes');
    const listaContainer = document.getElementById('listaOrdenesSeleccionadas');
    const noHayOrdenes = document.getElementById('noHayOrdenes');

    // Seleccionar todas
    selectAll.addEventListener('change', function () {
        checkboxes.forEach(cb => cb.checked = this.checked);
        actualizarSeleccion();
        actualizarListaVisual();
    });

    // Actualizar contador e importe
    function actualizarSeleccion() {
        let seleccionadas = 0;
        let total = 0;

        document.querySelectorAll('.orden-checkbox-modal:checked').forEach(cb => {
            seleccionadas++;
            total += parseFloat(cb.closest('tr').getAttribute('data-arancel')) || 0;
        });

        contador.textContent = seleccionadas;
        importeInput.value = total.toFixed(2);
    }

    checkboxes.forEach(cb => cb.addEventListener('change', () => {
        actualizarSeleccion();
        actualizarListaVisual();
    }));

    // Actualizar lista visual detallada
    function actualizarListaVisual() {
        listaContainer.innerHTML = '';  // Limpiamos

        const seleccionadas = [];
        document.querySelectorAll('.orden-checkbox-modal:checked').forEach(cb => {
            const row = cb.closest('tr');
            const id = row.getAttribute('data-orden-id');
            const paciente = row.cells[2].textContent.trim();
            const doctor = row.cells[3].textContent.trim();
            const clinica = row.cells[4].textContent.trim();
            const trabajo = row.cells[5].textContent.trim();
            const arancel = row.cells[6].textContent.trim();
            seleccionadas.push({ id, paciente, doctor, clinica, trabajo, arancel });
        });

        if (seleccionadas.length === 0) {
            noHayOrdenes.style.display = 'block';
            return;
        }

        noHayOrdenes.style.display = 'none';

        seleccionadas.forEach(orden => {
            const div = document.createElement('div');
            div.className = 'border-bottom py-2';
            div.innerHTML = `
                <strong>Orden ${orden.id}</strong> - 
                Paciente: ${orden.paciente} - 
                Doctor: ${orden.doctor} - 
                Clínica: ${orden.clinica} - 
                Trabajo: ${orden.trabajo} - 
                Arancel: ${orden.arancel}
            `;
            listaContainer.appendChild(div);
        });
    }

    // Confirmar selección y cerrar modal
    confirmarBtn.addEventListener('click', function () {
        // Limpiar selecciones actuales
        Array.from(ordenesSelect.options).forEach(opt => opt.selected = false);

        // Seleccionar las que están checked
        document.querySelectorAll('.orden-checkbox-modal:checked').forEach(cb => {
            const ordenId = cb.closest('tr').getAttribute('data-orden-id');
            const option = ordenesSelect.querySelector(`option[value="${ordenId}"]`);
            if (option) option.selected = true;
        });

        actualizarSeleccion();
        actualizarListaVisual();
        modal.hide();
    });

    // Si hay preseleccionadas (editar) o al cargar
    if (ordenesSelect) {
        Array.from(ordenesSelect.selectedOptions).forEach(option => {
            const row = document.querySelector(`tr[data-orden-id="${option.value}"]`);
            if (row) {
                row.querySelector('.orden-checkbox-modal').checked = true;
            }
        });
        actualizarSeleccion();
        actualizarListaVisual();  // ← clave: llama aquí al cargar
    }

});
</script>

<script>

function cancelarModal() {
    // Recargar sin parámetros GET (limpia filtros) y SIN reabrir modal
    window.location.href = "{{ url_for(request.endpoint, **request.view_args) }}";
}

// Filtrar la tabla con JS (sin recargar)
function filtrarTabla() {
    const tabla = document.getElementById('tablaOrdenesModal');
    const filas = tabla.querySelectorAll('tbody tr');

    // Obtener valores de los filtros
    const fechaDesdeInput = document.querySelector('input[name="fecha_desde"]').value; // yyyy-mm-dd
    const fechaHastaInput = document.querySelector('input[name="fecha_hasta"]').value; // yyyy-mm-dd
    const doctorId = document.querySelector('select[name="doctor_id"]').value; // ID numérico como string
    const clinica = document.querySelector('input[name="clinica"]').value.trim().toLowerCase();
    const estadoOrden = document.querySelector('select[name="estado_orden"]').value;
    const q = document.querySelector('input[name="q"]').value.trim().toLowerCase();

    filas.forEach(fila => {
        const cells = fila.cells;
        let mostrar = true;

        // 1. Fecha (conversión a Date para comparar correctamente)
        const fechaInicioStr = cells[7].textContent.trim(); // ej: "19/01/2026"
        if (fechaInicioStr !== '-' && fechaInicioStr !== '') {
            const [dia, mes, anio] = fechaInicioStr.split('/');
            const fechaInicio = new Date(anio, mes - 1, dia); // Date object

            if (fechaDesdeInput) {
                const fechaDesde = new Date(fechaDesdeInput);
                if (fechaInicio < fechaDesde) mostrar = false;
            }
            if (fechaHastaInput) {
                const fechaHasta = new Date(fechaHastaInput);
                if (fechaInicio > fechaHasta) mostrar = false;
            }
        }

        // 2. Doctor (comparar ID, no texto)
        if (doctorId) {
            const dataDoctorId = fila.getAttribute('data-doctor-id'); // ¡AGREGAR ESTO EN LA TABLA!
            if (dataDoctorId !== doctorId) mostrar = false;
        }

        // 3. Clínica (texto parcial)
        if (clinica) {
            const clinicaCell = cells[4].textContent.trim().toLowerCase();
            if (!clinicaCell.includes(clinica)) mostrar = false;
        }

        // 4. Estado
        if (estadoOrden) {
            const estado = cells[8].textContent.trim();
            if (estado !== estadoOrden) mostrar = false;
        }

        // 5. Búsqueda rápida (en toda la fila)
        if (q) {
            const textoFila = fila.textContent.toLowerCase();
            if (!textoFila.includes(q)) mostrar = false;
        }

        fila.style.display = mostrar ? '' : 'none';
    });
}

// Limpiar filtros y mostrar todo
function limpiarFiltros() {
    // Limpiar todos los inputs y selects del form de filtros
    const form = document.getElementById('filtroOrdenesModal');
    if (form) {
        form.reset();  // resetea a valores por defecto (vacíos)
    }

    // Mostrar todas las filas de la tabla (si usás JS para filtrar)
    const filas = document.querySelectorAll('#tablaOrdenesModal tbody tr');
    filas.forEach(fila => fila.style.display = '');
}

document.addEventListener('DOMContentLoaded', function () {
    const input = document.querySelector('input[name="numero_factura"]');

    // Solo permite números mientras escribís
    input.addEventListener('input', function (e) {
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    // Validación final antes de enviar
    facturaForm.addEventListener('submit', function (e) {
        if (input.value.length === 0 || !/^[0-9]+$/.test(input.value)) {
            e.preventDefault();
            input.classList.add('is-invalid');
            input.focus();
        } else {
            input.classList.remove('is-invalid');
        }
    });
});

</script>





{% endblock %}
