{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Órdenes de Trabajo</h1>

<!-- FILTROS -->
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <form method="GET" class="row g-3" id="filterForm">
            <div class="col-md-3">
                <label class="form-label small">Fecha Inicio</label>
                <input type="date" name="fecha_inicio" class="form-control" value="{{ request.args.get('fecha_inicio') }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small">Fecha Fin</label>
                <input type="date" name="fecha_entrega" class="form-control" value="{{ request.args.get('fecha_entrega') }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small">Doctor</label>
                <select name="doctor_id" class="form-select">
                    <option value="">Todos</option>
                    {% for d in doctores %}
                    <option value="{{ d.id }}" {% if request.args.get('doctor_id') == d.id|string %}selected{% endif %}>
                        {{ d.nombre_completo() }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Clínica del Doctor</label>
                <input type="text" name="clinica" class="form-control" placeholder="Ej: Dental Total" value="{{ request.args.get('clinica') or '' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small">Estado Orden</label>
                <select name="estado_orden" class="form-select">
                    <option value="">Todos</option>
                    <option value="Iniciado" {% if request.args.get('estado_orden') == 'Iniciado' %}selected{% endif %}>Iniciado</option>
                    <option value="En Proceso" {% if request.args.get('estado_orden') == 'En Proceso' %}selected{% endif %}>En Proceso</option>
                    <option value="Entregado" {% if request.args.get('estado_orden') == 'Entregado' %}selected{% endif %}>Entregado</option>
                    <option value="Finalizado" {% if request.args.get('estado_orden') == 'Finalizado' %}selected{% endif %}>Finalizado</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Estado Facturación</label>
                <select name="estado_facturacion" class="form-select">
                    <option value="">Todos</option>
                    <option value="Sin_Factura" {% if request.args.get('estado_facturacion') == 'Sin_Factura' %}selected{% endif %}>Sin Factura</option>
                    <option value="Facturado" {% if request.args.get('estado_facturacion') == 'Facturado' %}selected{% endif %}>Facturado</option>
                    <option value="Pagado" {% if request.args.get('estado_facturacion') == 'Pagado' %}selected{% endif %}>Pagado</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Búsqueda rápida</label>
                <input type="text" name="q" class="form-control" placeholder="Paciente / Detalle" value="{{ request.args.get('q') or '' }}">
            </div>
            <div class="col-12 d-flex gap-2 mt-3">
                <button type="submit" class="btn btn-primary flex-grow-1">Filtrar</button>
                <a href="{{ url_for('ordenes_trabajo') }}" class="btn btn-outline-secondary flex-grow-1">Limpiar Filtros</a>
            </div>
        </form>
    </div>
</div>

<!-- TABLA -->
<div class="table-responsive">
    <table class="table table-sm table-striped table-hover table-bordered text-center" id="ordenesTable">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Doctor</th>
                <th>Clínica</th>
                <th>Paciente</th>
                <th>Tipo</th>
                <th>Trabajo</th>
                <th>Maxilar</th>
                <th>Detalle Piezas</th>
                <th>Cant. Piezas</th>
                <th>Inicio</th>
                <th>Entrega</th>
                <th>Arancel</th>
                <th>Bonificación</th>
                <th>% Bonificación</th>
                <th>Importe Final</th>
                <th>Indicaciones</th>
                <th>Número Factura</th>
                <th>Importe Factura</th>
                <th>Estado Facturación</th>
                <th>Estado Orden</th>
                <th>Ticket</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for o in ordenes %}
            <tr>
                <td>{{ o.id }}</td>
                <td>{{ o.doctor.nombre_completo() if o.doctor else '-' }}</td>
                <td>{{ o.doctor.clinica_particular or '-' }}</td>
                <td>{{ o.paciente }}</td>
                <td>{{ o.tipo_trabajo.nombre if o.tipo_trabajo else '-' }}</td>
                <td>{{ o.trabajo.nombre if o.trabajo else '-' }}</td>
                <td>{{ o.maxilar }}</td>
                <td>{{ o.detalle_piezas or '-' }}</td>
                <td>{{ o.cant_piezas }}</td>
                <td>{{ o.fecha_inicio.strftime('%d/%m/%Y') }}</td>
                <td>{{ o.fecha_entrega.strftime('%d/%m/%Y') }}</td>
                <td>${{ o.arancel_fijo|round(2) if o.arancel_fijo else '0.00' }}</td>
                <td>
                    {% if o.bonificacion %}
                        <span class="badge bg-success">Sí</span>
                    {% else %}
                        <span class="badge bg-secondary">No</span>
                    {% endif %}
                </td>
                <td>
                    {% if o.porcentaje_bonificacion and o.porcentaje_bonificacion > 0 %}
                        {{ o.porcentaje_bonificacion }}%
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>${{ o.importe_final|round(2) if o.importe_final else '0.00' }}</td>
                <td>{{ o.indicaciones or '-' }}</td>
                <td>
                    {% if o.detalles and o.detalles[0].factura %}
                        <a href="{{ url_for('editar_factura', id=o.detalles[0].factura.id) }}" target="_blank">
                            {{ o.detalles[0].factura.numero_factura }}
                        </a>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if o.detalles and o.detalles[0].factura %}
                        ${{ "%.2f"|format(o.detalles[0].factura.importe) }}
                    {% else %}
                        $0.00
                    {% endif %}
                </td>
                <td>
                    {% if o.detalles and o.detalles[0].factura %}
                        {{ o.detalles[0].factura.estado }}
                    {% else %}
                        Sin_Factura
                    {% endif %}
                </td>
                <td>{{ o.estado_orden }}</td>
                <td>
                    <a href="{{ url_for('orden_ticket', id=o.id) }}" target="_blank" class="btn btn-sm btn-secondary">
                        Imprimir Ticket
                    </a>
                </td>
                <td>
                    <a href="{{ url_for('editar_orden_trabajo', id=o.id) }}" class="btn btn-warning btn-sm">Editar</a>
                    <form action="{{ url_for('borrar_orden_trabajo', id=o.id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('¿Seguro que querés borrar esta orden?')">Borrar</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Botones exportar y nueva orden -->
<div class="d-flex gap-3 mb-4">
    <button id="exportPdf" class="btn btn-primary">Exportar PDF</button>
    <button id="exportExcel" class="btn btn-success">Exportar Excel</button>
    <a href="{{ url_for('agregar_orden_trabajo') }}" class="btn btn-primary ms-auto">+ Nueva Orden</a>
</div>

<!-- Scripts para exportar -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
document.getElementById('exportPdf').addEventListener('click', function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    doc.text('Órdenes de Trabajo - Laboratorio MV', 14, 20);
    doc.autoTable({ html: '#ordenesTable', startY: 30, theme: 'grid' });
    doc.save('ordenes_trabajo.pdf');
});

document.getElementById('exportExcel').addEventListener('click', function() {
    const wb = XLSX.utils.table_to_book(document.getElementById('ordenesTable'));
    XLSX.writeFile(wb, 'ordenes_trabajo.xlsx');
});
</script>

<style>
.table-sm th, .table-sm td {
    padding: 0.4rem !important;
    font-size: 0.9rem;
}
</style>

{% endblock %}