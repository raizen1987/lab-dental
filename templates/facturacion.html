{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Facturación</h1>

<!-- FILTROS -->
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <form method="GET" class="row g-3" id="filterForm">
            <div class="col-md-3">
                <label class="form-label small">Fecha Desde</label>
                <input type="date" name="fecha_desde" class="form-control" value="{{ request.args.get('fecha_desde') }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small">Fecha Hasta</label>
                <input type="date" name="fecha_hasta" class="form-control" value="{{ request.args.get('fecha_hasta') }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small">Destinatario</label>
                <input type="text" name="destinatario" class="form-control" placeholder="Nombre o parte" value="{{ request.args.get('destinatario') or '' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small">Trabajo</label>
                <select name="trabajo_id" class="form-select">
                    <option value="">Todos</option>
                    {% for t in trabajos %}
                    <option value="{{ t.id }}" {% if request.args.get('trabajo_id') == t.id|string %}selected{% endif %}>
                        {{ t.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Estado</label>
                <select name="estado" class="form-select">
                    <option value="">Todos</option>
                    <option value="FACTURADO" {% if request.args.get('estado') == 'FACTURADO' %}selected{% endif %}>Facturado</option>
                    <option value="PAGADO" {% if request.args.get('estado') == 'PAGADO' %}selected{% endif %}>Pagado</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Doctor</label>
                <select name="doctor_id" class="form-select">
                    <option value="">Todos</option>
                    {% for d in doctores %}
                    <option value="{{ d.id }}" {% if request.args.get('doctor_id') == d.id|string %}selected{% endif %}>
                        {{ d.nombre_completo() }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 d-flex gap-2 mt-3">
                <button type="submit" class="btn btn-primary flex-grow-1">Filtrar</button>
                <a href="{{ url_for('facturacion') }}" class="btn btn-outline-secondary flex-grow-1">Limpiar Filtros</a>
            </div>
        </form>
    </div>
</div>

<!-- TABLA -->
<div class="table-responsive">
    <table class="table table-striped table-hover" id="facturasTable">
        <thead class="table-dark">
            <tr>
                <th>Número</th>
                <th>Fecha</th>
                <th>Destinatario</th>
                <th>Trabajo</th>
                <th>Importe</th>
                <th>Estado</th>
                <th>Paciente</th>
                <th>Doctor</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for f in facturas %}
            <tr>
                <td>{{ f.numero_factura }}</td>
                <td>{{ f.fecha.strftime('%d/%m/%Y') }}</td>
                <td>{{ f.destinatario or '-' }}</td>
                <td>{{ f.trabajo.nombre if f.trabajo else '-' }}</td>
                <td>${{ "%.2f"|format(f.importe) }}</td>
                <td>{{ f.estado }}</td>
                <td>{{ f.paciente or '-' }}</td>
                <td>{{ f.doctor.nombre_completo() if f.doctor else '-' }}</td>
                <td>
                    <a href="{{ url_for('editar_factura', id=f.id) }}" class="btn btn-warning btn-sm">Editar</a>
                    <form action="{{ url_for('borrar_factura', id=f.id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('¿Seguro que querés borrar esta factura?')">Borrar</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot class="table-info">
            <tr>
                <td colspan="4"><strong>Totales</strong></td>
                <td><strong>${{ "%.2f"|format(total_importe) }}</strong></td>
                <td colspan="4"></td>
            </tr>
        </tfoot>
    </table>
</div>

<!-- Botones exportar y nueva factura -->
<div class="d-flex gap-3 mb-4">
    <button id="exportPdf" class="btn btn-primary">Exportar PDF</button>
    <button id="exportExcel" class="btn btn-success">Exportar Excel</button>
    <a href="{{ url_for('agregar_factura') }}" class="btn btn-primary ms-auto">+ Nueva Factura</a>
</div>

<!-- Scripts para exportar -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
document.getElementById('exportPdf').addEventListener('click', function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    doc.text('Facturación - Laboratorio MV', 14, 20);
    doc.autoTable({ html: '#facturasTable', startY: 30, theme: 'grid' });
    doc.save('facturacion.pdf');
});

document.getElementById('exportExcel').addEventListener('click', function() {
    const wb = XLSX.utils.table_to_book(document.getElementById('facturasTable'));
    XLSX.writeFile(wb, 'facturacion.xlsx');
});
</script>
{% endblock %}
